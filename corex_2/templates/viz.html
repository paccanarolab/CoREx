{% load static from staticfiles %}
<!doctype html>
<html lang="en" class="js">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
        <link rel="stylesheet" href="{% static "css/style.css" %}">
        <title>Protein-protein network visualiser</title>
    </head>
    <body>
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md col-lg-8 blog-main">
                    <div class="blog-post">
                        <h2 id="network"></h2>
                        <!-- <h4><a href="https://torresmateo.com">Mateo Torres</a></h4> -->
                        <div id="graph"></div>
                        <div class="input-group">
                            <select class="custom-select" id="drug-select">
                            </select>
                        </div>
                        <!-- <div id="interactive_properties" class="radio-toolbar">
                        </div> -->
                        <!-- <h4>Load your scores</h4>
                        <p>You can upload a scoring to be assigned to the proteins of this network.</p>
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <a class="nav-link active" id="textcsv-tab" data-toggle="tab" href="#textcsv" role="tab" aria-controls="textcsv" aria-selected="false">Plain text</a>
                            </li>
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" id="home-tab" data-toggle="tab" href="#file-upload" role="tab" aria-controls="file" aria-selected="true">File Upload</a>
                            </li>
                        </ul>
                        <div class="tab-content" id="myTabContent">
                            <div class="tab-pane fade show active" id="textcsv" role="tabpanel" aria-labelledby="textcsv-tab">
                                <div class="container_textupload">
                                    <form id="text-input">
                                        <div class="form-group">
                                            <label for="score_name_text">Score Name</label>
                                            <input type="text" class="form-control" id="score_name_text" placeholder="Fancy centrality">
                                        </div>
                                        <div class="form-group">
                                            <label for="default_score_text">Default Score</label>
                                            <input type="text" class="form-control" id="default_score_text" placeholder="The default value for proteins (defaults to the minimum score)">
                                        </div>
                                        <div class="form-group">
                                            <label for="csv-input">Example textarea</label>
                                            <textarea class="form-control" id="csv-input" rows="10" placeholder=""></textarea>
                                        </div>
                                        <button id="submit-csv" type="submit" class="btn btn-primary mb-2">Submit</button>
                                    </form>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="file-upload" role="tabpanel" aria-labelledby="file-tab">
                                <div class='container_uploadbox'>
                                    <form method="post" action="#" enctype="multipart/form-data" novalidate="" class="box has-advanced-upload">
                                        <div class="form-group">
                                            <label for="score_name_drop">Score Name</label>
                                            <input type="text" class="form-control" id="score_name_drop" placeholder="Fancy centrality">
                                        </div>
                                        <div class="form-group">
                                            <label for="default_score_drop">Default Score</label>
                                            <input type="text" class="form-control" id="default_score_drop" placeholder="The default value for proteins (defaults to the minimum score)">
                                        </div>
                                        <div class="box__input">
                                            <svg class="box__icon" xmlns="http://www.w3.org/2000/svg" width="50" height="43" viewBox="0 0 50 43"><path d="M48.4 26.5c-.9 0-1.7.7-1.7 1.7v11.6h-43.3v-11.6c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v13.2c0 .9.7 1.7 1.7 1.7h46.7c.9 0 1.7-.7 1.7-1.7v-13.2c0-1-.7-1.7-1.7-1.7zm-24.5 6.1c.3.3.8.5 1.2.5.4 0 .9-.2 1.2-.5l10-11.6c.7-.7.7-1.7 0-2.4s-1.7-.7-2.4 0l-7.1 8.3v-25.3c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v25.3l-7.1-8.3c-.7-.7-1.7-.7-2.4 0s-.7 1.7 0 2.4l10 11.6z"></path></svg>
                                            <input type="file" name="files[]" id="file" class="box__file" data-multiple-caption="{count} files selected" multiple="">
                                            <label for="file"><strong>Choose a file</strong><span class="box__dragndrop"> or drag it here</span>.</label>
                                            <button type="submit" class="box__button">Upload</button>
                                        </div>
                                        <div class="box__uploading">Uploadingâ€¦</div>
                                        <div class="box__success">Done! <a href="https://css-tricks.com/examples/DragAndDropFileUploading//?" class="box__restart" role="button">Upload more?</a></div>
                                        <div class="box__error">Error! <span></span>. <a href="https://css-tricks.com/examples/DragAndDropFileUploading//?" class="box__restart" role="button">Try again!</a></div>
                                        <input type="hidden" name="ajax" value="1">
                                    </form>
                                </div>
                            </div>
                        </div> -->
                        
                    </div>
                </div>
            </div>
        </div>
        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
        <!-- not boilerplate stuff -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.2.2/math.min.js"></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="{% static "js/dragndropupload.js" %}"></script>
        <script src="{% static "js/papaparse.min.js" %}"></script>
        <script src="{% static "js/ppi.js" %}"></script>
        <script>
            //var files = $('#files')[0].files;
            var drugs = null;
            var ppi_chart = null;
            fetch("{%static 'data/drugs.json'%}")
            .then(response => response.json())
            .then(data => {
                drugs = data;
                var select_elem = d3.select('#drug-select');
                for(let s = 0; s < data.drugs.length; s++){
                    select_elem.append('option')
                    .attr('value', data.drugs[s])
                    .text(data.drugs[s]);
                }
                ppi_chart = new PPI('#graph', graph_file, 'drug-select');
            });
            //var queryVars = new URLSearchParams(window.location.search);
            //alert(queryVars);
            var net = '{{ net }}';
            var network = document.getElementById('network');
            network.innerHTML=net;
            var graph_file = `{% static '/data/' %}${net.toLowerCase()}.json`;
            var interactive_properties = d3.select('#interactive_properties');
            var i = 0;
            var properties = ['betweenness'];

            var placeholder = "Enter comma separated values for proteins and scores...\nP13984, 1\nP09601, 1\nO95613, 2\nO00203, 1";
            //document.getElementById('csv-input').placeholder = placeholder

            var update_radio = function(score_name, scores){

                var props = interactive_properties.selectAll('.properties')
                    .data(properties);

                var property = props.enter()
                    .append('div')
                    .attr('class', 'properties');//.merge(props);
                
                property.append('input').attr('class', 'property');
                property.select('.property')
                    .attr('type', 'radio')
                    .attr('id', d => `${d}`)
                    .attr('name', 'interactive_property')
                    .attr('value', d => `${d}`)
                    .on('click', d => ppi_chart.update_chart(d));
                
                property.append('label').attr('class', 'property-label');
                property.select('.property-label')
                    .attr('for', d=>d)
                    .html(d => d);

                props.exit().remove();
            };

            d3.select('#button').on('click', function(){
                properties.push(`option-${i}`);
                i++;
                //update_radio();
            });

            d3.select('#submit-csv').on('click', function(){
                d3.event.stopPropagation();
                d3.event.preventDefault();
                var form = document.getElementById('text-input');
                var csv_input = document.getElementById('csv-input');
                var title = document.getElementById('score_name_text');
                var score_name = title.value;
                var scores = Papa.parse(csv_input.value);
                var default_score = document.getElementById('default_score_text').value;
                default_score = default_score.length > 0? default_score : 'min';
                if(scores.data.length > 0 && score_name.length > 0){
                    ppi_chart.set_scores(score_name, scores.data, default_score);
                    properties.push(score_name);
                    form.reset();
                    update_radio();
                }
            });

            var load_score = function(){
                var select_elem = document.getElementById('drug-select');
                //console.log(select_elem.value);
                //ppi_chart.load_drug_score(select_elem.value, `static/data/${select_elem.value}.json`);
                ppi_chart.load_drug_score(select_elem.value, `{% static '/data/' %}${select_elem.value}.json`);

                //ppi_chart.update_chart(select_elem.value);
            }

            d3.select('#drug-select').on('change', load_score);

            //update_radio();

        </script>
    </body>
</html>